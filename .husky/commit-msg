#!/bin/sh
# Pure POSIX sh script - works with sh, dash, bash, zsh, etc.

set -e

commit_msg=$(cat "$1")

# Use printf with octal escape sequences for maximum cross-platform compatibility
FAIL_BADGE=$(printf '\033[30;41m')
INFO=$(printf '\033[97m')
RESET=$(printf '\033[0m')
SUCCESS_BADGE=$(printf '\033[30;42m')

commit_regex="^(feat|fix|chore|docs|style|refactor|test|perf|build|ci)(\(.+\))?: .+|^Merge.*|^Revert.*"

if ! echo "$commit_msg" | grep -Eq "$commit_regex"; then
  printf "\n%b\n" "${FAIL_BADGE} FAILED ${RESET} Commit message does not match the required pattern:"
  printf "%b\n" "${INFO}   - feat: <message> or feat(scope): <message>${RESET}"
  printf "%b\n" "${INFO}   - fix: <message> or fix(scope): <message>${RESET}"
  printf "%b\n" "${INFO}   - chore: <message>${RESET}"
  printf "%b\n" "${INFO}   - docs: <message>${RESET}"
  printf "%b\n" "${INFO}   - style: <message>${RESET}"
  printf "%b\n" "${INFO}   - refactor: <message>${RESET}"
  printf "%b\n" "${INFO}   - test: <message>${RESET}"
  printf "%b\n" "${INFO}   - Merge.*${RESET}"
  printf "%b\n" "${INFO}   - Revert.*${RESET}"
  printf "\n%b\n" "Your message: '${commit_msg}'"
  exit 1
fi

# Extract message without prefix (use basic sed for BSD/GNU compatibility)
message_only=$(echo "$commit_msg" | sed 's/^[^:]*: *//')

# Check if message is empty after removing whitespace
if [ -z "$(echo "$message_only" | tr -d ' \t\n\r')" ]; then
  printf "\n%b\n" "${FAIL_BADGE} FAILED ${RESET} Commit message cannot be empty"
  printf "%b\n" "${INFO}Please provide a descriptive commit message after the prefix.${RESET}"
  exit 1
fi

# Convert message to lowercase for comparison (portable way)
message_lower=$(echo "$message_only" | tr 'A-Z' 'a-z')

# Check against banned words (no arrays, use case statement)
case "$message_lower" in
  things|stuff|changes|update|fix|test|wip)
    printf "\n%b\n" "${FAIL_BADGE} FAILED ${RESET} Please provide a more descriptive commit message\n"
    printf "%b\n" "${INFO}Examples:${RESET}"
    printf "%b\n" "${INFO}   - feat: add user authentication${RESET}"
    printf "%b\n" "${INFO}   - fix: resolve null pointer exception in login${RESET}"
    printf "%b\n" "${INFO}   - chore: update dependencies to latest versions${RESET}\n"
    exit 1
    ;;
esac

printf "%b\n" "${SUCCESS_BADGE} PASSED ${RESET} Commit message validation passed\n"
